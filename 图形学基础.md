# 渲染管线

## 深度测试、Alpha测试、模板测试

先后顺序：裁剪测试 -> Alpha测试 -> 模板测试 ->深度测试

- **深度测试**：图形管线会对每一个位置的像素存储一个深度值，称为Depth Buffer，代表了该像素点在3D世界中离相机最近物体的深度值。在计算灭一个物体的像素值时，都会将它的深度值与Depth Buffer中的深度值比较，小于则更新Depth Buffer和Color Buffer中的值；否则丢弃。简单来说，就是根据物体的深度决定是否渲染。
- **Alpha测试**：可选的 Alpha 测试可在深度测试执行前在传入片段上运行。片段的Alpha值与参考值作某些特定的测试（如等于，大于等），如果片段未能通过测试，它将不再进行进一步的处理。 Alpha测试经常用于不影响深度缓存的全透明片段的处理。简单来说，就是根据物体的透明度来决定是否渲染。
- **模板测试**：模板测试通过模板缓冲来控制像素渲染。模板缓冲记录特定图元的位置，如同在屏幕上设定了一个区域“模板”。渲染时，将片段的参考值与模板值进行比较：满足条件则通过测试并更新像素，否则丢弃该片段。简单来说，就是根据物体的位置范围决定是否渲染。

# PBR

PBR（Physically Based Rendering，基于物理的渲染）是一系列遵循真实世界物理规律，尤其是光学原理的渲染技术的统称。它通过更科学地模拟光线与材质的相互作用，使得渲染效果相比传统的Phong或Blinn-Phong等经验式光照模型更为真实、自然。

判断一种PBR光照模型是否是属于基于物理的：

1. 基于微平面的表面模型
2. 能量守恒
3. 应用基于物理的BRDF

## 理论

### 位平面模型

PBR技术的核心是微平面理论，该理论将宏观表面视为无数微观镜面的集合。表面粗糙度决定了这些微平面的排列秩序：粗糙表面微平面排列混乱，光滑表面则趋向一致。

这种微观结构直接决定了镜面反射的形态：粗糙表面将光线散射到各个方向，形成模糊扩散的高光；光滑表面则将光线集中反射，产生锐利清晰的反射光斑。

由于微平面远小于像素尺度，我们引入0-1之间的粗糙度参数进行统计描述。通过半程向量

$$
\begin{aligned}
\mathbf{h} &= \frac{\mathbf{l} + \mathbf{v}}{\|\mathbf{l} + \mathbf{v}\|}
\end{aligned}
$$
可计算微平面取向与理想反射方向的匹配程度。微平面越接近半程向量方向，镜面反射越强。

粗糙度为0时，微平面排列高度一致，产生小而锐利的高光；粗糙度为1时，微平面方向高度分散，形成宽泛模糊的反射。

### 能量守恒

微平面理论遵循能量守恒：出射光总能量不超过入射光（发光面除外）。

光线击中表面后分为反射与折射两部分：反射光形成镜面反射；折射光进入材质，经散射吸收后部分射出成为漫反射。

金属（Metallic）与绝缘体（Dielectrics）行为不同：金属会立即吸收所有折射光，因此只显示镜面色，几乎无漫反射。

反射与折射能量互斥：反射的能量不再被吸收。根据能量守恒，先计算镜面反射比例，漫反射即为剩余能量。

```cpp
float kS = calculateSpecularComponent(...); // 反射/镜面 部分
float kD = 1.0 - ks;                        // 折射/漫反射 部分
```

### BEDF

BRDF（双向反射分布函数）用于量化光线与材质表面的交互。它以入射方向 $w_i$ 、出射方向$w_o$ 、表面法线$n$及粗糙度参数$\alpha$为输入，计算指定材质表面上每束入射光对最终出射亮度的贡献。

例如，在理想镜面上，除恰好符合反射定律的那一束入射光外，BRDF对所有其他入射方向均返回0.0；只有该入射方向会对出射方向$w_o$贡献值为1.0的亮度。

#### Cook-Torrance BRDF

Cook-Torrance BRDF 模型包含漫反射与镜面反射两部分：

漫反射项（Lambertian）的归一化表达式为：
$$
\begin{aligned}
f_r = k_d f_{\text{Lambert}} + k_s f_{\text{Cook-Torrance}}
\end{aligned}
$$

- $k_d$：折射（漫反射）能量占比

- $c$：表面颜色（来自漫反射贴图）
- $\pi$：归一化因子，保证能量守恒

Cook-Torrance BRDF 的镜面反射项具有以下形式：
$$
\begin{aligned}
f_{\text{Cook-Torrance}}(\omega_i, \omega_o) = \frac{D(\mathbf{h}, \alpha) \, F(\omega_o, \mathbf{h}, F_0) \, G(\omega_i, \omega_o, \alpha)}{4 (\omega_o \cdot \mathbf{n})(\omega_i \cdot \mathbf{n})}
\end{aligned}
$$

- $D(h,\alpha)$：法线分布函数，表示微平面法线与半程向量$\mathbf{h}$一致的分布概率，受粗糙度$\alpha$影响；
- $F(\omega_o, \mathbf{h}, F_0)$：菲涅尔项，计算反射比，依赖于出射方向$w_o$、半程向量$\mathbf{h}$及基础反射率$F_0$；
- $G(\omega_i, \omega_o, \alpha)$：几何遮挡项，描述微平面自阴影与遮蔽，取决于入射方向$w_i$、出射方向$w_o$和粗糙度$\alpha$；
- 分母：归一化因子，与入射和出射方向对法线的余弦值有关。

#### Cook-Torrance反射率方程

$$
\begin{aligned}
L_o(p, \omega_o) = \int_{\Omega} 
\left(
k_d \frac{c}{\pi} 
+ k_s \frac{DFG}{4 (\omega_o \cdot \mathbf{n})(\omega_i \cdot \mathbf{n})}
\right)
L_i(p, \omega_i) (\mathbf{n} \cdot \omega_i) \, d\omega_i
\end{aligned}
$$



## 光照

## IBL

# GI

## AO

AO（Ambient Occlusion）环境光遮蔽是一种模拟全局光照中遮蔽阴影的技术。它通过计算物体表面因周围几何体遮挡而减少的环境光，来生成重要的视觉明暗效果。该技术能有效描绘物体交界处、裂缝、孔洞等细节区域的柔和阴影，从而解决漏光、阴影漂浮等问题，显著增强场景的深度感、立体感和细节表现力。

从直观的视觉效果看，开启环境光遮蔽后，场景的整体亮度会趋于自然，而局部细节——尤其是暗部阴影——会变得更加清晰和丰富，画面因此显得更加扎实、富有层次。

## SSAO

SSAO（Screen Space Ambient Occlusion）屏幕空间环境光遮蔽是一种用于实时实现近似环境光遮蔽效果的渲染技术。通过获取像素的深度缓冲、法线缓冲来计算实现，来近似的表现物体在间接光下产生的阴影。

### SSAO实现